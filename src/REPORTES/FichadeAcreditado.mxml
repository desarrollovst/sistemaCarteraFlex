<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="240" height="172" backgroundAlpha="1.0" 
	backgroundColor="#FFFFFF" creationPolicy="all" creationComplete="initApp()" 
	verticalScrollPolicy="off" horizontalScrollPolicy="off" xmlns:Data="Data.*">
	<mx:states>
		<mx:State name="impresion">
			<mx:SetProperty name="height" value="390"/>
			<mx:SetProperty target="{lblControl}" name="visible" value="true"/>
			<mx:SetProperty target="{lblControl}" name="y" value="360"/>
			<mx:AddChild position="lastChild">
				<Data:RowColorDataGrid id="dgAcred" x="18.45" y="169" width="570.5" height="183" editable="true"
					sortableColumns="false" resizableColumns="false" itemEditBeginning="desabilitaEdicion(event)"> 
					<Data:columns>
						<mx:DataGridColumn headerText="" dataField="REGISTRO" textAlign="center" rendererIsEditor="true" width="30" editorDataField="selected">
							<mx:itemRenderer>
								<mx:Component>
									<mx:CheckBox change="outerDocument.seleccionarReg(event)" width="25" fontSize="10" verticalCenter="0"/> 
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						<mx:DataGridColumn headerText="CODIGO" dataField="CDGCL" width="50" editable="false"/>
						<mx:DataGridColumn headerText="ACREDITADO" dataField="NOMBREC" width="180" editable="false"/>
					</Data:columns>
				</Data:RowColorDataGrid>
			</mx:AddChild>
			<mx:SetProperty name="width" value="610"/>
			<mx:AddChild position="lastChild">
				<mx:Button id="btnImprimir" x="528.95" y="358" icon="@Embed(source='assets/images/iconAccept.png')" click="enviar()" enabled="true" toolTip="Imprimir" width="60"/>
			</mx:AddChild>
		</mx:State>
	</mx:states>
	
	<mx:transitions>
		<mx:Transition fromState="*" toState="*">		
			<mx:Parallel>
				<mx:Resize duration="1000" target="{this}"/> 
			</mx:Parallel>
		</mx:Transition>
	</mx:transitions>
	
	<mx:Script>
		<![CDATA[
			import Data.Globales;
			import Data.Utils;
			import mx.collections.ArrayCollection;
			import mx.core.Application;	
			import mx.controls.Alert;
			import mx.controls.CheckBox;
			import mx.effects.easing.Elastic;
			import mx.events.DataGridEvent;
			import mx.formatters.NumberFormatter;		
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.soap.WebService;
			import mx.utils.ObjectUtil;
			
			private var _xmlRep:XML =  new XML();
			
			public var wsMS:WebService;
			public var titulo:String;
			public var acred:String;
			public var codigo:String;
			public var clns:String;
			public var ciclo:String;
			public var rep:String;
			private var du:Utils;
			private var global:Globales;
			
			public var regObj:ArrayCollection = new ArrayCollection();
		
			private function calculaRegSel():Number{
				var cont:Number = 0;
				var listaReg:ArrayCollection;
				
				listaReg = dgAcred.dataProvider as ArrayCollection;
				
				for (var i:int = 0; i < listaReg.length; i++){
					if(listaReg[i].REGISTRO == true)
						cont++;
				}
				return cont;
			}
		
			private function consultar():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				
				if(valida()){
					codigo = txtCodigo.text;
					ciclo = txtCiclo.text;
					clns = "G";
					
					du.initWsCat(wsCat);
					du.sCursor();
							
					du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
						_xmlRep = new XML(evt.result.toString());
						
						du.rCursor();
						du.closeWs(wsCat);
											
						if(_xmlRep.elements().length() > 0){
							currentState = "impresion";
							formatearReg();
							dgAcred.dataProvider = regObj;
							lblControl.text = calculaRegSel().toString() + " Registro(s) seleccionado(s)";
						}
						else{
							Alert.show("No se encontraron registros que coincidan con los criterios de consulta.\n\nVerifique los datos seleccionados.",titulo,4,null,null,global.iAlert);
							limpiar();
						}
					});
					params[0] = codigo;
					params[1] = ciclo;
					params[2] = Application.application.U_ID;
					//Obtiene la lista de Acreditados para realizar la impresion de sus fichas de datos
					wsCat.getListado.send(51, params); 
				}	
			}					
			
			public function desabilitaEdicion(event:DataGridEvent):void{
				event.preventDefault();
			} 
			
			private function enviar():void{
				if(validaReg()){
					var consulta:String;
					formatearRegAcred();
					
					var id:String = "&id=" + rep;
					var tipo:String = "&tipo=" + tipo;
					var consGrupo:String = "&grupo=" + codigo;
					var consCiclo:String = "&ciclo=" + ciclo;
					var consAcred:String = "&acred=" + acred;
					consulta = global.urlPdf + id + tipo + consGrupo + consCiclo + consAcred;
					
					Application.application.muestraPdf(consulta);
				}
			}
			
			private function formatearReg():void{
				var cont:int = _xmlRep.elements().length();
				var oItem:Object;
				var item:Array = new Array();
				
				regObj.removeAll();
				regObj.refresh();
				
				for (var i:int = 0; i < cont; i++){
					oItem = new Object();
					oItem.REGISTRO = true;
					oItem.CDGCL = _xmlRep.Table[i].CDGCL;
					oItem.NOMBREC = _xmlRep.Table[i].NOMBREC;
					item.push(oItem);
				}
				regObj = new ArrayCollection(item);
			}
			
			private function formatearRegAcred():void{
				var listaReg:ArrayCollection;
				
				listaReg = dgAcred.dataProvider as ArrayCollection;
				acred = "";
				
				if (listaReg != null){
					var cont:int = listaReg.length;
						
					for(var i:int = 0; i < cont; i++){
						if (listaReg[i].REGISTRO == true){
							acred += (acred != ""? "|" : "") + listaReg[i].CDGCL; 							
						}
					}
				}
			}	
			
			public function initApp():void{
				global = new Globales();
				du = new Utils();
				rep = "44";
				titulo = "Ficha de Acreditado";
				lblTitulo.text = titulo.toUpperCase();
				limpiar();
			}		
			
			public function initConexion():void{				
				wsMS = new WebService();			
				wsMS.wsdl = Application.application.wsStr.wsdlServ.toString();
				wsMS.loadWSDL();
			}	
		
			private function limpiar():void{
				txtCodigo.text = "";
				txtCiclo.text = "";
				lblControl.text = "";
				currentState = null;
			}
			
			public function seleccionarReg(event:Event):void{
				var ind:int;
				var vScroll:Number;
				ind = dgAcred.selectedIndex;
				vScroll = dgAcred.verticalScrollPosition;
				regObj[ind].REGISTRO = CheckBox(event.currentTarget).selected;
				lblControl.text = calculaRegSel().toString() + " Registro(s) seleccionado(s)";
			}	
				
			private function valida():Boolean{
				if(txtCodigo.text == "" || txtCodigo.text.length < 6){
					Alert.show("Capture el código de grupo.",titulo,4,null,null,global.iAlert);
					return false;
				}
				if(txtCiclo.text == ""){
					Alert.show("Capture el ciclo del crédito.",titulo,4,null,null,global.iAlert);
					return false;
				}
				return true;
			}
			
			private function validaReg():Boolean{
				var n:int = calculaRegSel();
				if(n == 0){
					Alert.show("Debe seleccionar al menos un registro para iniciar el proceso.",titulo,4,null,null,global.iAlert);
					return false;
				}
				return true;
			}
		]]>
	</mx:Script>
	<mx:Label id="lblTitulo" x="19.55" y="10" width="200.95" fontSize="12" fontWeight="bold" fontStyle="italic"/>
	<mx:Canvas x="19.5" y="53.5" width="201.04999" height="75.5" styleName="canvasMod">
		<mx:Label x="20.75" y="10" text="Grupo" width="47.5" height="20"/>
		<mx:TextInput id="txtCodigo" x="20.75" y="29" maxChars="6" restrict="0-9" enter="consultar()"/>
		<mx:Label x="121.75" y="10" text="Ciclo" height="20"/>
		<mx:TextInput id="txtCiclo" x="121.75" y="29" maxChars="6" restrict="0-9" enter="consultar()" width="40"/>
	</mx:Canvas>
	<mx:Button x="40.5" y="137" label="Consultar" click="consultar()"/>
	<mx:Button x="128.5" y="137" label="Limpiar" width="71" height="24" click="limpiar()"/>
	<mx:Label x="19.55" y="34" text="Criterios de Selección" width="124.25"/>
	<mx:Label id="lblControl" x="17.95" y="168" width="380.05" fontWeight="bold" fontStyle="italic" fontSize="12" visible="false"/>
</mx:Canvas>