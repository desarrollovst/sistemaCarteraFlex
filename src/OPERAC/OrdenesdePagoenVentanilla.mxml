<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="initApp()" width="100%" xmlns:forms="forms.*" 
	xmlns:Data="Data.*" horizontalScrollPolicy="off" creationPolicy="all" xmlns:Administracion="Administracion.*" 
	height="100%">
	
	<!--Componente de traspaso de ordenes de pago-->
	<mx:Script>
		<![CDATA[
			import Data.Utils;
			import mx.controls.Alert;
			import mx.controls.DataGrid;
			import mx.controls.dataGridClasses.DataGridItemRenderer;  
			import Data.Globales;
			import mx.controls.ComboBox;
			import mx.events.FlexEvent;
			import mx.events.ValidationResultEvent;
			import mx.rpc.Fault;
			import mx.rpc.soap.WebService;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.xml.SimpleXMLDecoder;
			import mx.events.DataGridEvent;				
			import mx.events.CloseEvent;	
			import mx.events.ListEvent;	
			import mx.core.Application;
			import mx.containers.TitleWindow;				
			import mx.managers.PopUpManager;
			import mx.collections.ArrayCollection;
			import mx.effects.easing.Elastic;
			import mx.utils.ArrayUtil;  
			          
			public var _xmlGrupos:XML = new XML();
			public var _xmlCta:XML = new XML();
			
			public var titulo:String;
			public var rep:String;
			private var du:Utils;
			private var global:Globales;
			
			private var wsMS:WebService;
		
			public var acred:Array;
			public var chqAcred:Array;
			
			public var acredObj:ArrayCollection = new ArrayCollection();
			
			public function activarContAcred(band:Boolean):void{
				btnDatosAcred.enabled = band;	
			}	
					
			public function actualizarAcred(event:Event):void{
				buscarListaAcred();
			}
			
			public function actualizarCta(event:Event):void{
				var comMttoCta:MttoCuenta = event.currentTarget as MttoCuenta;
				txtCodCuenta.text = comMttoCta.dgCuenta.selectedItem.CODIGO;
				txtCuenta.text = comMttoCta.dgCuenta.selectedItem.BANCO;			
			}
			
			public function buscarCuenta():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				if (txtCodCuenta.text != ""){
					txtCuenta.setFocus();
					
					du.initWsCat(wsCat);
					du.sCursor();
					global.bloquear();
					
					du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
						_xmlCta = new XML(evt.result);
						
						du.rCursor();
						du.closeWs(wsCat);
						global.desbloquear();
						
						if (_xmlCta.elements().length() > 0){
							txtCuenta.text = _xmlCta.Table[0].BANCO;
						}
						else{
							txtCuenta.text = "";
							Alert.show("No se ha encontrado información de la cuenta.\n\nVerifique los datos capturados.",titulo,4,null,null,global.iAlert);
						}
					});
					params[0] = "1";
					params[1] = txtCodCuenta.text;
					params[2] = "";
					params[3] = global.obtenerUsuario();
					params[4] = "";
					wsCat.getInfoRegistro.send(3, params);
				}	
			}
			
			public function buscarGrupo():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				if (txtCodGrupo.text != "" || txtGrupo.text != ""){
					btnBuscar.setFocus();
					dgGrupos.dataProvider = null;
					
					du.initWsCat(wsCat);
					du.sCursor();
					global.bloquear();
					
					du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
						_xmlGrupos = new XML(evt.result);
						
						du.rCursor();
						du.closeWs(wsCat);
						global.desbloquear();
						
						if(_xmlGrupos.elements().length() > 0){
							dgGrupos.dataProvider = _xmlGrupos.Table;
						}
						seleccionaGrupo();
					});
					params[0] = global.obtenerUsuario();
					params[1] = txtCodGrupo.text;
					params[2] = txtGrupo.text;
					params[3] = dtfFecha.text;
					wsCat.getListado.send(38, params);
				}	
			}
			
			public function buscarListaAcred():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				var grupo:String = dgGrupos.selectedItem.CDGNS;
				var ciclo:String = dgGrupos.selectedItem.CICLO;
				dgAcred.dataProvider = null;
				
				du.initWsCat(wsCat);
			 	du.sCursor();
			 	
			 	du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
					var resp:String = evt.result.toString();
							
					du.rCursor();
					du.closeWs(wsCat);
					global.desbloquear();
					
					formateaListaAcred(resp);
					dgAcred.dataProvider = acredObj;
				});
				params[0] = grupo;
				params[1] = ciclo;
				wsCat.getListado.send(10, params);
			}

			public function enviar():void{
				if(valida() == true){
					var grupo:String = dgGrupos.selectedItem.CDGNS;
					var ciclo:String = dgGrupos.selectedItem.CICLO;
					var cuenta:String = txtCodCuenta.text;
					var fecha:String = global.formatoFecha(global.obtenerFechaSistema());
					formateaRegAcred();
					
					initConexion();
					du.sCursor();
							
					du.ejecutaWsMethod(wsMS,function(evt:ResultEvent):void {																				
						var res:String = evt.result.toString();
						
						du.rCursor();
						du.closeWs(wsMS);	
						
						var id:String = "&id=" + rep;
						var consGrupo:String = "&grupo=" + grupo;
						var consCiclo:String = "&ciclo=" + ciclo;
						var consulta:String = global.urlPdf + id + consGrupo + consCiclo;
						
						if (res.substr(0,1) == "1")
							Application.application.muestraPdf(consulta);
						else if(res.substr(0,1) == "2")
							Alert.show(res.substr(2,res.length -1), titulo, 4, null, 
								function(e:Event):void{
									Application.application.muestraPdf(consulta);
								}, global.iAlert);
						else
							Alert.show(res.substr(2,res.length -1),titulo,4,null,null,global.iAlert);		
					});
					wsMS.setAccionOrdenPago.send(grupo, ciclo, acred, chqAcred, fecha, global.obtenerUsuario(),  cuenta);	
				}
			}
			
			public function formateaListaAcred(info:String):void{
				var xml:XMLDocument = new XMLDocument(info); 
     			var decoder:SimpleXMLDecoder = new SimpleXMLDecoder();  
     			var data:Object = decoder.decodeXML(xml);  
				var array:Array = ArrayUtil.toArray(data.NewDataSet.Table);   
				acredObj = new ArrayCollection(array);
			}
			
			public function formateaRegAcred():void{
				var i:int;
				var cont:int;
				var listaAcred:ArrayCollection = dgAcred.dataProvider as ArrayCollection;  
				
				cont = listaAcred.length;
				acred = new Array;
				chqAcred = new Array;
				
				for(i = 0; i < cont; i++){
					acred[i] = listaAcred[i].CDGCL;
					chqAcred[i] = listaAcred[i].CHEQUE;
				}
			}
			
			public function initApp():void{
				global = new Globales();
				du = new Utils();
				rep = "18";
				titulo = "Ordenes de Pago en Ventanilla";
				lblTitulo.text = titulo.toUpperCase();
				var fec:Date = global.obtenerFechaSistema();
				dtfFecha.selectedDate = global.seleccionaDiaHabil(new Date(fec.fullYear,fec.month,fec.date));
			}
			
			public function initConexion():void{				
				wsMS = new WebService();			
				wsMS.wsdl = Application.application.wsStr.wsdlServ.toString();
				wsMS.loadWSDL();
			}
			
			public function muestraFormCta():void{
				var comMttoCta:MttoCuenta = new MttoCuenta();
				comMttoCta = MttoCuenta(PopUpManager.createPopUp(this,MttoCuenta,true));
				comMttoCta.init(2);
				comMttoCta.addEventListener("enviar", actualizarCta);
				PopUpManager.centerPopUp(comMttoCta);
			}
		
			public function seleccionaGrupo():void{
				acredObj.removeAll();
				acredObj.refresh();
				dgAcred.dataProvider = null;
				if (dgGrupos.selectedIndex >= 0)
					activarContAcred(true);
				else
					activarContAcred(false);
			}
			
			private function valida():Boolean{
				if(dgGrupos.selectedIndex < 0){
					Alert.show("No se ha seleccionado ningún Grupo para imprimir las ordenes de Pago.",titulo,4,null,null,global.iAlert);
					return false;
				}	
				if(acredObj.length == 0){
					Alert.show("No se ha desplegado la lista de acreditados del Grupo.",titulo,4,null,null,global.iAlert);
					return false;
				}
				if(txtCuenta.text == ""){
					Alert.show("Debe seleccionar la Cuenta Bancaria.",titulo,4,null,null,global.iAlert);
					return false;
				}
				return true;
			}
		]]>
	</mx:Script>
	<mx:Canvas backgroundAlpha="1.0" backgroundColor="#FFFFFF" width="650" height="590">
		<mx:Canvas id="cnvDetalle" x="10" y="141" width="630.25" height="146" styleName="canvasMod" visible="true">
			<Data:RowColorDataGrid id="dgGrupos" x="10" y="10" width="608.25" height="124"
				sortableColumns="false" resizableColumns="false" verticalScrollPolicy="on" itemClick="seleccionaGrupo()" doubleClickEnabled="true" 
				itemDoubleClick="buscarListaAcred()"> 
				<Data:columns>
					<mx:DataGridColumn headerText="CODIGO" dataField="CDGNS" width="70"/>
					<mx:DataGridColumn headerText="GRUPO" dataField="NOMBRE_NS" width="200"/>
					<mx:DataGridColumn headerText="CICLO" dataField="CICLO" width="50"/>
				</Data:columns>
			</Data:RowColorDataGrid>
		</mx:Canvas>
		<mx:Label x="10" y="76" text="GRUPO" width="247.5" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="573.5" y="96" width="61" height="37" styleName="canvasMod" visible="true">
			<mx:Button id="btnBuscar" x="10" y="3" icon="@Embed(source='assets/images/iconBusq.png')" click="buscarGrupo()" toolTip="Buscar Grupo" width="40"/>
		</mx:Canvas>
		<mx:Canvas x="15" y="96" width="550.5" height="37" styleName="canvasMod" visible="true">
			<mx:Label id="lblCodGrupo" x="10" y="7" text="CODIGO:" width="53"/>
			<mx:Label id="lblGrupo" x="137" y="7" text="GRUPO:" width="52.5"/>
			<mx:TextInput id="txtGrupo" x="187" y="5" width="351.5" enter="buscarGrupo()" maxChars="50"/>
			<mx:TextInput id="txtCodGrupo" x="64" y="5" width="68" enter="buscarGrupo()" maxChars="6" restrict="0-9"/>
		</mx:Canvas>
		<mx:Label x="10" y="311" text="ACREDITADO" width="247" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="573.5" y="295" width="60" height="37" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true">
			<mx:Button id="btnDatosAcred" x="9" y="3" icon="@Embed(source='assets/images/folder.png')" click="buscarListaAcred()" enabled="false" toolTip="Acreditados del Grupo" width="40"/>
		</mx:Canvas>
		<mx:Canvas id="cnvDetalle2" x="10" y="340" width="630.25" height="146" styleName="canvasMod" visible="true" verticalScrollPolicy="off">
			<Data:RowColorDataGrid id="dgAcred" x="10" y="10" width="608.25" height="124"
				sortableColumns="false" draggableColumns="false" resizableColumns="false" verticalScrollPolicy="on"> 
				<Data:columns>
					<mx:DataGridColumn headerText="CODIGO" dataField="CDGCL" width="50"/>
					<mx:DataGridColumn headerText="ACREDITADO" dataField="NOMBREC" width="180"/>
					<mx:DataGridColumn headerText="CICLO" dataField="CICLO" width="50"/>
					<mx:DataGridColumn headerText="MONTO AUTORIZADO" dataField="CANTAUTOR" width="100"/>
				</Data:columns>
			</Data:RowColorDataGrid>
		</mx:Canvas>
		<mx:Label id="lblTitulo" x="10" y="10" width="380.5" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="103.75" y="31" width="430.5" height="37" styleName="canvasMod" visible="true">
			<mx:Label id="lblFecha" x="10" y="8" text="FECHA DE ENTREGA DE CRÉDITO:" width="202.75" textAlign="right"/>
			<mx:DateField id="dtfFecha" x="216.75" y="6" width="100"/>
		</mx:Canvas>
		<mx:Label id="lblTitCuenta" x="10" y="494" text="CUENTA BANCARIA" width="247" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="103.75" y="514" width="430.5" height="37" styleName="canvasMod" visible="true">
			<mx:TextInput id="txtCuenta" x="137" y="5" width="231.5" editable="false"/>
			<mx:TextInput id="txtCodCuenta" x="84" y="5" width="45" maxChars="2" restrict="0-9" enter="buscarCuenta()"/>
			<mx:Label id="lblEtiqCuenta" x="18" y="7" text="CUENTA:" width="60" textAlign="right"/>
			<mx:Button id="btnBusqCta" x="377" y="3" icon="@Embed(source='assets/images/iconBusq.png')" click="muestraFormCta()" toolTip="Buscar Cuenta" width="40"/>
		</mx:Canvas>
		<mx:Button id="btnAceptar" x="560.25" y="556" icon="@Embed(source='assets/images/iconAccept.png')" click="enviar()" enabled="true" toolTip="Aceptar" width="80"/>
	</mx:Canvas>
</mx:Canvas>