<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="400" height="370" creationPolicy="all">
<mx:DataGrid id="dgEntidad" x="159" y="173" width="171" height="120" visible="false" showHeaders="false" itemClick="selecEntidad()" keyDown="presDGEntidad(event)">
	<mx:columns>
		<mx:DataGridColumn dataField="nombre"/>
	</mx:columns>	
</mx:DataGrid>
<mx:DataGrid id="dgMunicipio" x="159" y="205" width="171" height="120" visible="false" showHeaders="false" itemClick="selecMunic()" keyDown="presDGMunicipio(event)">
	<mx:columns>
		<mx:DataGridColumn dataField="nombre"/>
	</mx:columns>	
</mx:DataGrid>
<mx:DataGrid id="dgLocalidad" x="157.5" y="237" width="171" height="120" visible="false" showHeaders="false" itemClick="selecLocalidad()" keyDown="presDGLocalidad(event)">
	<mx:columns>
		<mx:DataGridColumn dataField="nombre"/>
	</mx:columns>	
</mx:DataGrid>
	<mx:Metadata>
		[Event(name="enviarDatosAcred", type="Data.EventAcred")]
	</mx:Metadata>
	
	<mx:Validator id="calleV" source="{txtCalle}" property="text" 
	invalid="{txtCalle.setFocus()}" triggerEvent="" requiredFieldError="Nombre de Calle Requerido"/>
	
	<mx:Validator id="entFedV" source="{txtEntFed}" property="text" 
	invalid="{txtEntFed.setFocus()}" triggerEvent="" requiredFieldError="Nombre de Entidad Federativa Requerido"/>
	
	<mx:Validator id="municipioV" source="{txtMunicipio}" property="text" 
	invalid="{txtMunicipio.setFocus()}" triggerEvent="" requiredFieldError="Nombre de Municipio Requerido"/>
	
	<mx:Validator id="localidadV" source="{txtLocalidad}" property="text" 
	invalid="{txtLocalidad.setFocus()}" triggerEvent="" requiredFieldError="Nombre de Localidad Requerido"/>

	<mx:Script>
		<![CDATA[
			import Data.EventAcred;
			import Data.DatosAcred;
			import Data.Utils;
			import Data.Globales;
			import mx.validators.Validator;
			import mx.collections.ArrayCollection;
			import mx.core.Application;			
			import mx.managers.PopUpManager;
			import mx.controls.Alert;
			import mx.effects.easing.Elastic;
			import mx.rpc.soap.WebService;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.utils.StringUtil;
			
			private var _xmlDirNeg:XML =  new XML();
			private var _xmlEntidad:XML =  new XML();
			private var _xmlMunicipio:XML =  new XML();
			private var _xmlLocalidad:XML =  new XML();
			private var _xmlInegiEqu:XML =  new XML();
			
			public var acEntidad:ArrayCollection = new ArrayCollection();
			public var acMunicipio:ArrayCollection = new ArrayCollection();
			public var acLocalidad:ArrayCollection = new ArrayCollection();
			public var datos:DatosAcred = new DatosAcred();
				
			private var global:Globales;
			private var wsMS:WebService;
			private var du:Utils;
			public var texto:String;
			
			public function buscaEntidad():void{
				if(txtEntFed.text != ''){	
					dgEntidad.selectedIndex = -1;
					texto = txtEntFed.text;					
					acEntidad.filterFunction = filtraEntidad;
					acEntidad.refresh();
					if(acEntidad.length > 0){
						dgEntidad.validateNow();
						dgEntidad.scrollToIndex(0);
						dgEntidad.selectedIndex = 0;
						dgEntidad.visible = true;
						this.setChildIndex(dgEntidad,this.numChildren - 1);
					}	
					else
						dgEntidad.visible = false;								
				}
				else{
					acEntidad.filterFunction = null;
					acEntidad.refresh();
					dgEntidad.visible = false;
				}
			}
			
			
			public function buscaLocalidad():void{
				if(txtMunicipio.text != ''){
					if(txtLocalidad.text != ''){	
						dgLocalidad.selectedIndex = -1;
						texto = txtLocalidad.text;					
						acLocalidad.filterFunction = filtraLocalidad;
						acLocalidad.refresh();
						if(acLocalidad.length > 0){
							dgLocalidad.validateNow();
							dgLocalidad.scrollToIndex(0);
							dgLocalidad.selectedIndex = 0;
							dgLocalidad.visible = true;
							this.setChildIndex(dgLocalidad,this.numChildren - 1);	
						}	
						else
							dgLocalidad.visible = false;							
					}
					else{
						acLocalidad.filterFunction = null;
						acLocalidad.refresh();
						dgLocalidad.visible = false;
					}
				}
				else{
					acLocalidad.filterFunction = null;
					acLocalidad.refresh();
					dgLocalidad.visible = false;
				}
			}
			
			public function buscaMunicipio():void{
				if(txtEntFed.text != ''){
					if(txtMunicipio.text != ''){	
						dgMunicipio.selectedIndex = -1;
						texto = txtMunicipio.text;					
						acMunicipio.filterFunction = filtraMunicipio;
						acMunicipio.refresh();
						if(acMunicipio.length > 0){
							dgMunicipio.validateNow();
							dgMunicipio.scrollToIndex(0);
							dgMunicipio.selectedIndex = 0;
							dgMunicipio.visible = true;
							
							this.setChildIndex(dgMunicipio,this.numChildren - 1);		
						}	
						else
							dgMunicipio.visible = false;								
					}
					else{
						acMunicipio.filterFunction = null;
						acMunicipio.refresh();
						dgMunicipio.visible = false;
					}
				}
				else{
					acMunicipio.filterFunction = null;
					acMunicipio.refresh();
					dgMunicipio.visible = false;
				}
			}
			
			public function cargaDirNeg(pXmlDirNeg:XML):void{
				_xmlDirNeg = pXmlDirNeg;
				
				datos.cdgDirEntFedNeg = _xmlDirNeg.CGEF_INEGI;
				datos.cdgMunNeg = _xmlDirNeg.CDGMU_INEGI;
				datos.cdgLocNeg = _xmlDirNeg.CDGLO_INEGI;
				
				datos.dirEntFedNeg = _xmlDirNeg.ENTIDAD_INEGI;
				datos.municipioNeg = _xmlDirNeg.MUNICIPIO_INEGI;
				datos.localidadNeg = _xmlDirNeg.LOCALIDAD_INEGI;
				datos.poblacionNeg = _xmlDirNeg.POBLACION;
				
				txtEntFed.text = datos.dirEntFedNeg;
				txtMunicipio.text = datos.municipioNeg;
				txtLocalidad.text = datos.localidadNeg;
				lblPoblacion.text = datos.poblacionNeg.toString();
				
				obtieneMunicipio();
				obtieneLocalidad();
			}
			
			public function enviarDatosAcred(formData:DatosAcred):void{
				var invalidArray:Array = Validator.validateAll([calleV, entFedV, municipioV, localidadV]);
				if(invalidArray.length == 0){	
					formData.calleNeg = StringUtil.trim(txtCalle.text);
					formData.entreCallesNeg = StringUtil.trim(txtEntreCalles.text);
					formData.noExtNeg = StringUtil.trim(txtNoExt.text);
					formData.noIntNeg = StringUtil.trim(txtNoInt.text);
					formData.telefonoNeg = StringUtil.trim(txtTelefono.text);
					formData.codPostalNeg = txtCodPostal.text;
					formData.cdgDirEntFedNeg = datos.cdgDirEntFedNeg;
					formData.cdgMunNeg = datos.cdgMunNeg;
					formData.cdgLocNeg = datos.cdgLocNeg;
					formData.coloniaNeg = StringUtil.trim(txtColonia.text);
					formData.guardaDirNeg = true;
				}
				else{
					formData.guardaDirNeg = false;
				}
				var event:EventAcred = new EventAcred("enviarDatosAcred", formData);
				dispatchEvent(event);
			}
			
			private function filtraCaptura(item:Object):Boolean{
				var isMatch:Boolean = false
				if(texto.toLowerCase().search(item.nombre.toLowerCase()) != -1)
					isMatch = true 
				return isMatch; 
			}
			
			public function filtraEntidad(item:Object):Boolean{
				var isMatch:Boolean = false
				if(item.nombre.toString().substr(0, texto.length).toLowerCase() == texto.toLowerCase())
					isMatch = true 
				return isMatch; 
			}
			
			public function filtraLocalidad(item:Object):Boolean{
				var isMatch:Boolean = false
				if(item.nombre.toString().substr(0, texto.length).toLowerCase() == texto.toLowerCase())
					isMatch = true 
				return isMatch; 
			}
			
			public function filtraMunicipio(item:Object):Boolean{
				var isMatch:Boolean = false
				if(item.nombre.toString().substr(0, texto.length).toLowerCase() == texto.toLowerCase())
					isMatch = true 
				return isMatch; 
			}
			
			private function formateaEntidad():void{
				var cont:int = _xmlEntidad.elements().length();
				var item:Array = new Array();
				var oItem:Object;
				
				acEntidad.filterFunction = null;
				acEntidad.refresh();
				acEntidad.removeAll();
				acEntidad.refresh();
						
				if(cont > 0 ){
					for (var i:int = 0; i < cont; i++){
						oItem = new Object();
						oItem.nombre = _xmlEntidad.Table[i].NOM_ENT;
						oItem.codigo = _xmlEntidad.Table[i].CVE_ENT;
						oItem.poblacion = _xmlEntidad.Table[i].POBLACION;
						item.push(oItem);
					}
					acEntidad = new ArrayCollection(item);
				}
			}
			
		    private function formateaLocalidad():void{
				var cont:int = _xmlLocalidad.elements().length();
				var item:Array = new Array();
				var oItem:Object;
				
				acLocalidad.filterFunction = null;
				acLocalidad.refresh();
				acLocalidad.removeAll();
				acLocalidad.refresh();
				
				if(cont > 0 ){
					for (var i:int = 0; i < cont; i++){
						oItem = new Object();
						oItem.nombre = _xmlLocalidad.Table[i].NOM_LOC;
						oItem.codigo = _xmlLocalidad.Table[i].CVE_LOC;
						oItem.poblacion = Number(_xmlLocalidad.Table[i].POBLACION);
						item.push(oItem);
					}
					acLocalidad = new ArrayCollection(item);
				}
			}
			
			private function formateaMunicipio():void{
				var cont:int = _xmlMunicipio.elements().length();
				var item:Array = new Array();
				var oItem:Object;
				
				acMunicipio.filterFunction = null;
				acMunicipio.refresh();
				acMunicipio.removeAll();
				acMunicipio.refresh();
				
				if(cont > 0 ){
					for (var i:int = 0; i < cont; i++){
						oItem = new Object();
						oItem.nombre = _xmlMunicipio.Table[i].NOM_MUN;
						oItem.codigo = _xmlMunicipio.Table[i].CVE_MUN;
						oItem.poblacion = _xmlMunicipio.Table[i].POBLACION;
						item.push(oItem);
					}
					acMunicipio = new ArrayCollection(item);
				}
			}
			
			public function init(info:DatosAcred):void{
				var wsCat:WebService = new WebService();
				global = new Globales();
				du = new Utils();
				var params:Array = new Array();
				
				du.initWsCat(wsCat);
				du.sCursor();
					
				_xmlEntidad = null;
				
				du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
					_xmlEntidad = new XML(evt.result.toString());
					
					if(_xmlEntidad.elements().length() > 0){
						formateaEntidad();
						dgEntidad.dataProvider = acEntidad;
					}
					
					du.rCursor();
					du.closeWs(wsCat);
					wsCat = null;
										
					if (info != null){
						txtCalle.text = info.calleNeg;
						txtEntreCalles.text = info.entreCallesNeg;
						txtNoExt.text = info.noExtNeg;
						txtNoInt.text = info.noIntNeg;
						txtTelefono.text = info.telefonoNeg;
						txtCodPostal.text = info.codPostalNeg;
						txtEntFed.text = info.dirEntFedNeg;
						txtMunicipio.text = info.municipioNeg;
						txtLocalidad.text = info.localidadNeg;
						txtColonia.text = info.coloniaNeg;
						lblPoblacion.text = info.poblacionNeg.toString();
						
						datos.cdgDirEntFedNeg = info.cdgDirEntFedNeg;
						datos.cdgMunNeg = info.cdgMunNeg;
						datos.cdgLocNeg = info.cdgLocNeg;
						
						if(info.cdgLocNeg.toString() != ""){
							obtieneMunicipio();
							obtieneLocalidad();
							
							txtEntFed.addEventListener(KeyboardEvent.KEY_DOWN, presEntidad);
						}
						else{
							if(info.cdgLoc.toString() != ""){
								var idSepomex:String = info.cdgDirEntFed + info.cdgMun + info.cdgLoc;
								
								wsCat = new WebService();
								params = new Array();
								
								du.initWsCat(wsCat);
								du.sCursor();
								
								du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
									_xmlInegiEqu = new XML(evt.result);
											
									du.rCursor();
									du.closeWs(wsCat);
											
									if (_xmlInegiEqu.elements().length() > 0){
										limpiaDatosDir();
										cargaDirNeg(_xmlInegiEqu.Table[0]);
									}							
								});
								params[0] = idSepomex;
								params[1] = "";
								params[2] = "";
								params[3] = "";
								params[4] = "";
								wsCat.getCatalogoGral.send(68, params);
							}
						}
					}
				});
				//Obtiene las entidades federativas del catalogo inegi
				params[0] = "";
				wsCat.getCatalogoGral.send(65, params);
			}
			
			public function initConexion():void{				
				wsMS = new WebService();			
				wsMS.wsdl = Application.application.wsStr.wsdlServ.toString();
				wsMS.loadWSDL();
			}	
			
			public function limpiaDatosDir():void{
				txtEntFed.text = "";
				txtMunicipio.text = "";
				txtLocalidad.text = "";
				txtColonia.text = "";	
						
				datos.cdgDirEntFedNeg = "";		
				datos.cdgMunNeg = "";
				datos.cdgLocNeg = "";	
			}
			
			public function obtieneCodEntFed():String{
				return datos.cdgDirEntFedNeg;
			}
			
			public function obtieneCodMun():String{
				return datos.cdgMunNeg;
			}
			
			public function obtieneCodLoc():String{
				return datos.cdgLocNeg;
			}
			
			public function obtieneLocalidad():void{
				var wsCat:WebService = new WebService();
				var params:Array = new Array();
				
				du.initWsCat(wsCat);
				du.sCursor();
				
				acLocalidad.removeAll();
				acLocalidad.refresh();
				
				du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
					_xmlLocalidad = new XML(evt.result.toString());
					
					if(_xmlLocalidad.elements().length() > 0){
						formateaLocalidad();
						dgLocalidad.dataProvider = null;
						dgLocalidad.dataProvider = acLocalidad;
					}
					
					du.rCursor();
					du.closeWs(wsCat);
					wsCat = null;
				});
				//Obtiene la informacion de las localidades de INEGI
				params[0] = datos.cdgDirEntFedNeg;
				params[1] = datos.cdgMunNeg;
				params[2] = "";
				wsCat.getCatalogoGral.send(67, params);
			}
			
			public function obtieneMunicipio():void{
				var wsCat:WebService = new WebService();
				var params:Array = new Array();
				
				du.initWsCat(wsCat);
				du.sCursor();
				
				acMunicipio.removeAll();
				acMunicipio.refresh();
				
				du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
					_xmlMunicipio = new XML(evt.result.toString());
					
					if(_xmlMunicipio.elements().length() > 0){
						formateaMunicipio();
						dgMunicipio.dataProvider = null;
						dgMunicipio.dataProvider = acMunicipio;
					}
					
					du.rCursor();
					du.closeWs(wsCat);
					wsCat = null;	
				});
				params[0] = datos.cdgDirEntFedNeg;
				params[1] = "";
				//obtiene informacion del municipio de inegi
				wsCat.getCatalogoGral.send(66, params);
			}
			
			private function presEntidad(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.DOWN){
					dgEntidad.setFocus();
				}				
			}
			
			private function presDGEntidad(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.ENTER){
					selecEntidad();
					txtEntFed.setFocus();
				}					
			}
			
			private function presLocalidad(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.DOWN){
					dgLocalidad.setFocus();
				}				
			}
			
			private function presDGLocalidad(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.ENTER){
					selecLocalidad();
					txtLocalidad.setFocus();
				}					
			}
			
			private function presMunicipio(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.DOWN){
					dgMunicipio.setFocus();
				}				
			}
			
			private function presDGMunicipio(event:KeyboardEvent):void{
				if(event.keyCode == Keyboard.ENTER){
					selecMunic();
					txtMunicipio.setFocus();
				}					
			}
			
			public function selecEntidad():void{
				if(dgEntidad.selectedIndex >= 0){
					var indice:int = dgEntidad.selectedIndex;
					
					//if (datos.cdgDirEntFed != entObj[indice].codigo){			
						txtEntFed.text = acEntidad[indice].nombre;
						datos.cdgDirEntFedNeg = acEntidad[indice].codigo;
						
						txtMunicipio.text = "";
						txtLocalidad.text = "";
						datos.cdgMunNeg = "";
						datos.cdgLocNeg = "";
						lblPoblacion.text = "";
						
						obtieneMunicipio();
					//}
					//else
						//txtEntFed.text = entObj[indice].nombre;
					dgEntidad.visible = false;
				}
			}
			
			public function selecLocalidad():void{
				if(dgLocalidad.selectedIndex >= 0){
					var indice:int = dgLocalidad.selectedIndex;
				
					if (datos.cdgLocNeg != acLocalidad[indice].codigo){
						txtLocalidad.text = acLocalidad[indice].nombre;
						datos.cdgLocNeg = acLocalidad[indice].codigo;
						lblPoblacion.text = acLocalidad[indice].poblacion;
					}
					else
						txtLocalidad.text = acLocalidad[indice].nombre;
					dgLocalidad.visible = false;
				}
			}
			
			public function selecMunic():void{
				if(dgMunicipio.selectedIndex >= 0){
					var indice:int = dgMunicipio.selectedIndex;
					if (datos.cdgMunNeg != acMunicipio[indice].codigo){
						txtMunicipio.text = acMunicipio[indice].nombre;
						datos.cdgMunNeg = acMunicipio[indice].codigo;
	
						txtLocalidad.text = "";
						datos.cdgLocNeg = "";
						lblPoblacion.text = "";
						
						obtieneLocalidad();
					}
					else
						txtMunicipio.text = acMunicipio[indice].nombre;
					dgMunicipio.visible = false;
				}
			}
			
			public function verificaEntidad():void{
				if (dgEntidad.selectedIndex < 0){
					dgEntidad.visible = false;
					texto = txtEntFed.text;
					acEntidad.filterFunction = filtraCaptura;
					acEntidad.refresh();
					if (acEntidad.length == 0){
						txtEntFed.text = "";
						datos.cdgDirEntFedNeg = "";
					}
					acEntidad.filterFunction = null;
					acEntidad.refresh();
				}
			}
			
			public function verificaLocalidad():void{
				if (dgLocalidad.selectedIndex < 0){
					dgLocalidad.visible = false;
					texto = txtLocalidad.text;
					acLocalidad.filterFunction = filtraCaptura;
					acLocalidad.refresh();
					if (acLocalidad.length == 0){
						txtLocalidad.text = "";
						datos.cdgLocNeg = "";
					}
					acLocalidad.filterFunction = null;
					acLocalidad.refresh();
				}
			}
			
			public function verificaMunicipio():void{
				if (dgMunicipio.selectedIndex < 0){
					dgMunicipio.visible = false;
					texto = txtMunicipio.text;
					acMunicipio.filterFunction = filtraCaptura;
					acMunicipio.refresh();
					if (acMunicipio.length == 0){
						txtMunicipio.text = "";
						datos.cdgMunNeg = "";
					}
					acMunicipio.filterFunction = null;
					acMunicipio.refresh();
				}
			}
	]]>
	</mx:Script>
	
	<mx:FormItem label="Calle:" id="calle" visible="true" x="111.5" y="16" width="224">
		<mx:TextInput id="txtCalle" maxChars="80" restrict="A-Z;a-z;Ñ;ñ;0-9; " width="170"/>
	</mx:FormItem>
	<mx:FormItem label="Entre las callles:" id="entreCalles" visible="true" x="59.5" y="48" width="276">
		<mx:TextInput id="txtEntreCalles" maxChars="50" restrict="A-Z;a-z;Ñ;ñ;0-9; " width="170"/>	
	</mx:FormItem>
	<mx:FormItem label="Número Exterior:" id="NoExt" visible="true" x="58" y="80" width="205">
		<mx:TextInput id="txtNoExt" maxChars="20" width="90"/>
	</mx:FormItem>
	<mx:FormItem label="Número Interior:" id="NoInt" visible="true" x="62" y="112" width="205">
		<mx:TextInput id="txtNoInt" maxChars="20" width="90"/>
	</mx:FormItem>
	<mx:FormItem label="Teléfono:" id="telefono" visible="true" x="93" y="144" width="230">
		<mx:TextInput id="txtTelefono" restrict="0-9" maxChars="20"/>
	</mx:FormItem>
	<mx:FormItem label="Código Postal:" id="codPostal" visible="true" x="70.5" y="176" width="188">
		<mx:TextInput id="txtCodPostal" width="95" maxChars="5" restrict="0-9"/>
	</mx:FormItem>
	<mx:FormItem label="Entidad Federativa:" id="EntFed" visible="true" x="46.5" y="208" width="290">
		<mx:TextInput id="txtEntFed" width="170" change="buscaEntidad()" enter="selecEntidad()" focusOut="verificaEntidad()" 
			restrict="A-Z;a-z;Ñ;ñ; " keyDown="presEntidad(event)"/>
	</mx:FormItem>
	<mx:FormItem label="Municipio:" id="municipio" visible="true" x="91.5" y="240" width="246">
		<mx:TextInput id="txtMunicipio" width="170" change="buscaMunicipio()" enter="selecMunic()" focusOut="verificaMunicipio()" 
			restrict="A-Z;a-z;Ñ;ñ; " keyDown="presMunicipio(event)"/>
	</mx:FormItem>
	<mx:FormItem label="Localidad:" id="localidad" visible="true" x="89.5" y="272" width="247">
		<mx:TextInput id="txtLocalidad" width="170" change="buscaLocalidad()" enter="selecLocalidad()" focusOut="verificaLocalidad()" 
			restrict="0-9;A-Z;a-z;Ñ;ñ; " keyDown="presLocalidad(event)"/>
	</mx:FormItem>
	<mx:FormItem label="Colonia:" id="colonia" visible="true" x="100.5" y="304" width="237">
		<mx:TextInput id="txtColonia" width="170" restrict="A-Z;a-z;Ñ;ñ;0-9; " />
	</mx:FormItem>
	<mx:Label x="90" y="336" text="Población:"/>
	<mx:Label x="158" y="336" id="lblPoblacion"/>
</mx:Canvas>